# GitHub Actions Workflow to build Mac apps
name: Build Mac Apps

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-arm:
    runs-on: macos-14  # ARM Mac (M1)
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build ARM app
        run: |
          pyinstaller --name="dHash Face Recognition ARM" \
            --windowed \
            --onefile \
            --add-data "templates:templates" \
            --add-data "static:static" \
            --hidden-import=PIL._imaging \
            --hidden-import=cv2 \
            --hidden-import=imagehash \
            --collect-all imagehash \
            --collect-all cv2 \
            desktop_app.py
      
      - name: Create ARM zip
        run: |
          cd dist
          zip -r dHash-ARM-M1-M2-M3.zip "dHash Face Recognition ARM.app"
      
      - name: Upload ARM artifact
        uses: actions/upload-artifact@v4
        with:
          name: dHash-ARM
          path: dist/dHash-ARM-M1-M2-M3.zip

  build-intel:
    runs-on: macos-13  # Intel Mac
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build Intel app
        run: |
          pyinstaller --name="dHash Face Recognition Intel" \
            --windowed \
            --onefile \
            --add-data "templates:templates" \
            --add-data "static:static" \
            --hidden-import=PIL._imaging \
            --hidden-import=cv2 \
            --hidden-import=imagehash \
            --collect-all imagehash \
            --collect-all cv2 \
            desktop_app.py
      
      - name: Create Intel zip
        run: |
          cd dist
          zip -r dHash-Intel-x86_64.zip "dHash Face Recognition Intel.app"
      
      - name: Upload Intel artifact
        uses: actions/upload-artifact@v4
        with:
          name: dHash-Intel
          path: dist/dHash-Intel-x86_64.zip
